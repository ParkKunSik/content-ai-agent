{% extends "task/base.jinja2" %}

{% block content %}
{#
    [상세 분석 메인 프롬프트 - 1단계: 구조화 및 추출]
    
    설명:
    콘텐츠 상세 분석의 첫 번째 단계로, 입력받은 콘텐츠 아이템들을
    카테고리별로 분류하고 감정 분석을 수행하여 구조화된 인사이트를 생성합니다.
    PRO_DATA_ANALYST 페르소나를 사용하며, 정확성을 최우선으로 합니다.
    
    번역:
    # 작업: 포괄적인 콘텐츠 분석 및 분류
    
    제공된 콘텐츠 아이템들을 분석하고 명확한 분류와 감정 분석을 통해 구조화된 인사이트를 만드십시오.
    
    ## 입력 데이터 구조
    JSON 배열 형태의 콘텐츠 아이템들을 받게 됩니다:
    ```json
    [
      {"id": 1, "content": "...", "has_image": true},
      {"id": 2, "content": "..."}
    ]
    ```
    **주의**: 필드가 없으면 `false`로 간주하십시오.
    
    ## 분석 요구사항
    
    ### 1. 카테고리 클러스터링
    - 유사한 주제들을 의미있는 카테고리로 그룹화 (최대 20개 카테고리)
    - 카테고리 명명: 사용자가 이해할 수 있는 명확하고 설명적인 이름 사용
    - **언어 일관성**: 콘텐츠의 주요 언어를 감지하여 카테고리명에도 동일한 언어 사용 (예: 한글 콘텐츠면 한글 카테고리명)
    - 검증 원칙: 여러 콘텐츠 아이템이 같은 주제를 공유할 때만 카테고리 생성
    - 우선 주제: 자주 언급되는 측면에 집중
    - **중요**: 각 id는 정확히 하나의 카테고리에만 속하며, harmful_contents나 etc_contents에 포함된 경우 카테고리 분류에서 완전히 제외됨
    
    ### 2. 감정 분석 (0.0~1.0 수치화)
    - 0.0에 가까울수록 부정적, 1.0에 가까울수록 긍정적으로 수치화
    - 분류 기준: 0.5 이상은 긍정 콘텐츠 (≥0.5), 0.5 미만은 부정 콘텐츠 (<0.5)
    - **중요**: 각 id를 한 번만 분류 - 카테고리 내에서도 positive_contents와 negative_contents 간 중복 불가
    - 카테고리별 상세 저장: positive_contents, negative_contents에 id와 score를 페어로 저장
    - 카테고리별 감정 유형: 해당 카테고리 평균 점수에 따라 sentiment_type 결정
      (negative: <0.4, positive: ≥0.6, neutral: 0.4~0.6)
    
    ### 3. 카테고리 키 생성
    - **규칙**: category에서 공백을 '_'로 대체하고 모든 문자를 소문자로 변환하여 category_key 생성
    - **예시**: "Product Quality" → "product_quality", "제품 품질" → "제품_품질"
    
    ### 4. 핵심 인사이트 추출 (주요 통찰)
    - 대표 인용문: 카테고리 본질을 포착하는 의미있는 문구 추출 (원문 그대로 유지)
    - 원본 키워드: 각 핵심 사항을 뒷받침하는 특정 용어/구문 식별 (번역하지 않음)
    - 콘텐츠 추적가능성: 각 핵심 사항을 그 출처 id에 연결
    - 품질 필터: 카테고리를 잘 대표하는 핵심 사항만 포함
    - **이미지 우선 타겟팅**: has_image가 true인 콘텐츠를 하이라이트 선정 시 우선적으로 고려
    - **수량 제한**: 카테고리당 최대 4개의 핵심 인사이트만 선별
    
    ### 5. 유해한 콘텐츠 처리
    - 유해한 콘텐츠 식별: 욕설, 비난, 비방, 혐오 표현 등이 포함된 콘텐츠
    - 분석 대상에서 완전 제외: 유해한 콘텐츠는 카테고리 분류 및 감정 분석에서 완전히 제외
    - 별도 추적: harmful_contents 배열에 해당 id들을 기록
    - **중요**: harmful_contents에 포함된 id는 어떤 카테고리나 감정 분석에도 포함되지 않음
    
    ### 6. 기타 콘텐츠 처리
    - 분석 영향 없는 콘텐츠: 유해하지 않으나 분석에 도움이 되지 않는 콘텐츠 식별
    - 예시: 단순 인사말, 의미 없는 반복, 관련 없는 내용 등
    - etc_contents에 id와 제외 이유를 함께 기록
    - **중요**: etc_contents에 포함된 id는 어떤 카테고리나 감정 분석에도 포함되지 않음
    
    ### 7. 요약 생성
    - 포괄적 개요: 모든 주요 주제를 다루는 상세한 요약 생성
    - 데이터 기반 통찰: 실제 콘텐츠 패턴에 기반한 결론
    - 전문적 어조: 객관적이고 분석적인 언어 유지
    - 길이 제약 없음: 정확성과 완전성에 집중 (정제는 2단계에서 진행)

    ## 출력 형식
    다음 구조를 가진 유효한 JSON 객체여야 합니다:

    **필수 JSON 생성 규칙**:
    1. **문자열 Escape 처리**: 모든 문자열 값은 특수문자를 반드시 escape 처리해야 함:
       - 큰따옴표: `"` → `\"`
       - 백슬래시: `\` → `\\`
       - 줄바꿈: `\n` → `\\n` (또는 공백으로 대체)
       - 탭: `\t` → `\\t` (또는 공백으로 대체)
       - 캐리지 리턴: `\r` → `\\r` (또는 제거)
    2. **문자열 값에 줄바꿈 금지**: 모든 문자열 값을 한 줄로 유지
    3. **유효한 JSON만**: 표준 JSON 파서로 파싱 가능하도록 보장

    **올바른 Escape 처리 예시**:
    ```json
    {
      "summary": "이것은 \\\"인용된\\\" 텍스트이며 줄바꿈 문자가 제거되었습니다",
      "categorys": [
        {
          "category": "제품 품질",
          "category_key": "제품_품질",
          "highlights": [
            {
              "highlight": "사용자가 말하길: \\\"훌륭한 제품!\\\""
            }
          ]
        }
      ]
    }
    ```

    **중요**: category_key는 category에서 공백을 '_'로 대체하고 소문자로 변환한 결과입니다
    
    ## 분석할 콘텐츠
    프로젝트 ID: {{ project_id }}
    프로젝트 타입: {{ project_type }}
    
    콘텐츠 아이템들:
    
    **중요**: JSON 객체만 반환하십시오. 추가 텍스트, 설명, 마크다운 형식 없이.
#}

# Task: Comprehensive Content Analysis and Categorization

Analyze the provided content items and create structured insights with clear categorization and sentiment analysis.

## Input Data Structure
You will receive a JSON array of content items:
```json
[
  {"id": 1, "content": "...", "has_image": true},
  {"id": 2, "content": "..."}
]
```
**Note**: `has_image` field is only present when `true`. If the field is missing, treat it as `false`.

## Analysis Requirements

### 1. Category Clustering (Maximum 20 Categories)
- **Theme grouping**: Group similar topics into meaningful categories
- **Clear naming**: Use descriptive names users can understand
- **Language Consistency**: Detect the main language of the content items and use THAT language for category names (e.g., if content is Korean, category must be Korean)
- **Quality threshold**: Only create categories when multiple content items share themes
- **Frequency focus**: Prioritize commonly mentioned aspects
- **CRITICAL**: Each id belongs to exactly ONE category. Content in harmful_contents or etc_contents must be completely excluded from categorization

### 2. Sentiment Analysis (0.0~1.0 Numerical Scale)
- **Sentiment scoring**: Quantify sentiment where 0.0 = most negative, 1.0 = most positive
- **Classification threshold**: 0.5 or above = positive content (≥0.5), below 0.5 = negative content (<0.5)
- **CRITICAL: Classify each id only once** - no duplicate between positive_contents and negative_contents within the same category
- **Category detailed storage**: Store id and score as pairs in positive_contents and negative_contents arrays
- **Category sentiment type**: Determine sentiment_type based on category average score
  (negative: <0.4, positive: ≥0.6, neutral: 0.4~0.6)

### 3. Category Key Generation
- **Rule**: Replace spaces with '_' in category and convert all characters to lowercase to create category_key
- **Examples**: "Product Quality" → "product_quality", "제품 품질" → "제품_품질"

### 4. Highlight Extraction (Key Insights)
- **Representative quotes**: Extract meaningful phrases that capture category essence (keep in original language)
- **Original keywords**: Identify specific terms/phrases that support each highlight (do not translate)
- **Content traceability**: Link each highlight to its source id
- **Quality filter**: Only include highlights that represent the category well
- **Image content prioritization**: When selecting highlights, prioritize content items where has_image is true
- **Quantity limit**: Select maximum 4 key insights per category

### 5. Harmful Content Processing
- **Identify harmful content**: Content containing profanity, abuse, slander, hate speech, etc.
- **Completely exclude from analysis**: Remove harmful content entirely from categorization and sentiment analysis
- **Track separately**: Record the ids in harmful_contents array
- **CRITICAL: ids in harmful_contents must not appear in any category or sentiment analysis**

### 6. Other Content Processing
- **Identify non-influential content**: Content that is not harmful but does not contribute to analysis
- **Examples**: Simple greetings, meaningless repetitions, irrelevant content, etc.
- **Record with reason**: Store id and exclusion reason in etc_contents array
- **CRITICAL: ids in etc_contents must not appear in any category or sentiment analysis**

### 7. Summary Generation
- **Comprehensive overview**: Create a detailed summary covering all major themes
- **Data-driven insights**: Base conclusions on actual content patterns
- **Professional tone**: Maintain objective, analytical language
- **No length constraints**: Focus on accuracy and completeness (refinement happens in Step 2)

## Output Format

Output must be a valid JSON object with the following structure:
{{ response_schema }}

**CRITICAL JSON Generation Rules**:
1. **String Escaping**: All string values MUST properly escape special characters:
   - Double quotes: `"` → `\"`
   - Backslashes: `\` → `\\`
   - Newlines: `\n` → `\\n` (or replace with space)
   - Tabs: `\t` → `\\t` (or replace with space)
   - Carriage returns: `\r` → `\\r` (or remove)
2. **No Line Breaks in String Values**: Keep all string values on a single line
3. **Valid JSON Only**: Ensure the output is parseable by standard JSON parsers

**Example of Proper Escaping**:
```json
{
  "summary": "This is a \"quoted\" text with a newline character removed",
  "categorys": [
    {
      "category": "Product Quality",
      "category_key": "product_quality",
      "highlights": [
        {
          "highlight": "User said: \\\"Great product!\\\""
        }
      ]
    }
  ]
}
```

**CRITICAL**: category_key is created by replacing spaces with '_' in category and converting to lowercase

## Content to Analyze

Project ID: {{ project_id }}
Project Type: {{ project_type }}

Content Items:
```json
{{ content_items }}
```

**Important**: Return ONLY the JSON object. No additional text, explanations, or markdown formatting.
{% endblock %}